Chapter 4 167 // To use StoredProcedureResponse and so on. using Microsoft.Azure.Cosmos.Scripts; 2. In Program.Methods.cs, add statements to define a method to create a stored procedure that can insert multiple products by chaining callback functions until all items in an array are inserted, as shown in the following code: static async Task CreateInsertProductStoredProcedure() { SectionTitle("Creating the insertProduct stored procedure"); try { using (CosmosClient client = new( accountEndpoint: endpointUri, authKeyOrResourceToken: primaryKey)) { Container container = client.GetContainer( databaseId: "Northwind", containerId: "Products"); StoredProcedureResponse response = await container .Scripts.CreateStoredProcedureAsync(new StoredProcedureProperties { Id = "insertProduct", // __ means getContext().getCollection(). Body = """ function insertProduct(product) { if (!product) throw new Error( "product is undefined or null."); tryInsert(product, callbackInsert); function tryInsert(product, callbackFunction) { var options = { disableAutomaticIdGeneration: false }; // __ is an alias for getContext().getCollection() var isAccepted = __.createDocument( __.getSelfLink(), product, options, callbackFunction); if (!isAccepted) getContext().getResponse().setBody(0); } 